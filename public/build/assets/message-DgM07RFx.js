const S=$('meta[name="selected_contact"]'),x=$('meta[name="selected_contact_type"]'),p=$('meta[name="base_url"]').attr("content"),l=$(".messages ul"),y=$(".message"),i=$('meta[name="auth_id"]').attr("content");let G={},c={},s=[];function C(){$(".loader").toggleClass("d-none")}function m(e,n){return`
        <li  class="${n}">
            <img src="${p}/images/avatar.jpg" alt="avatar" />
            <p>${e}</p>
        </li>
    `}function b(){$(".messages").stop().animate({scrollTop:$(".messages")[0].scrollHeight},500)}function U(e,n){$.ajax({url:p+"/messages",method:"GET",data:{contact_id:e,type:n},beforeSend:function(){C()},success:function(t){w(t.contact,t.type),t.messages.forEach(o=>{console.log(o.from_id==i),o.from_id!=i?l.append(m(o.message,"sent")):l.append(m(o.message,"replies"))}),b()},error:function(t){console.error("Error fetching messages:",t)},complete:function(){C()}})}function M(e,n){$.ajax({url:p+"/group-messages",method:"GET",data:{contact_id:e,type:n},beforeSend:function(){C()},success:function(t){w(t.contact,t.type),t.messages.forEach(o=>{o.from_id!=i?l.append(m(o.message,"sent")):l.append(m(o.message,"replies"))}),b()},error:function(t){console.error("Error fetching messages:",t)},complete:function(){C()}})}function w(e,n){console.log(n,e.members_names),n==="group"&&e.members_names?$(".contact-name").text(e.members_names):$(".contact-name").text(e.name)}function T(){const e=S.attr("content"),n=$(".message-form").serialize();$.ajax({url:p+"/send-message",method:"POST",data:n+"&contact_id="+e,beforeSend:function(){b()},success:function(t){},error:function(t){console.error("Error sending message:",t)}})}function L(){const e=S.attr("content"),n=$(".message-form").serialize();$.ajax({url:p+"/send-group-message",method:"POST",data:n+"&contact_id="+e,beforeSend:function(){b()},success:function(t){},error:function(t){console.error("Error sending message:",t)}})}function I(e){if(e&&!G[e]){c[e]=0;const n=window.Echo.join(`group_online.${e}`).subscribed(()=>{console.log(`Subscribed to group_online.${e}`)}).here(t=>{console.log(`Group ${e} - Online users:`,t);const o=t.filter(a=>{const r=String(a.id),f=String(i);return r!==f});c[e]=o.length,setTimeout(()=>{v(e,o.length>0)},100)}).joining(t=>{const o=String(t.id),a=String(i);o!==a&&(console.log(`User ${t.name} joined group ${e}`),c[e]=(c[e]||0)+1,v(e,!0))}).leaving(t=>{const o=String(t.id),a=String(i);o!==a&&(console.log(`User ${t.name} left group ${e}`),c[e]=Math.max(0,(c[e]||1)-1),v(e,c[e]>0))}).error(t=>{console.error(`Error joining group_online.${e}:`,t)});G[e]=n}}function O(){$('.contact[data-type="group"]').each(function(){const n=$(this).data("id");I(n)})}function v(e,n){const t=String(e),o=$(`.contact[data-id='${t}'][data-type='group']`);if(o.length===0){console.warn(`Group contact not found for group ID: ${t}`);return}const a=o.find(".contact-status");n?(a.removeClass("offline").addClass("online"),console.log(`Group ${t} status updated to: online`)):(a.removeClass("online").addClass("offline"),console.log(`Group ${t} status updated to: offline`))}function B(e){const n=String(e.id);if($(`.contact[data-id='${n}'][data-type='user']`).length>0){console.log("Contact already exists in list");return}let o=null;$("#contacts > div.mt-3.ms-3").each(function(){if($(this).text().trim()==="Friends")return o=$(this).next("ul"),!1}),(!o||o.length===0)&&(o=$("#contacts > ul").first()),o.find("p.text-center").remove();const r=s&&s.some(g=>String(g.id)===n)?"online":"offline",f=p+"/images/avatar.jpg",h=`
        <li class="contact" data-id="${e.id}" data-type="user">
            <div class="wrap">
                <span class="contact-status ${r}"></span>
                <img src="${f}" alt="avatar" />
                <div class="meta">
                    <p class="name">${e.name}</p>
                </div>
            </div>
        </li>`;o.append(h),console.log("New contact added to sidebar:",e.name,"Status:",r),D(e)}$(document).ready(function(){O(),$(document).on("click",".contact",function(){const e=$(this).data("id"),n=$(this).data("type")||"user";if(S.attr("content",e),x.attr("content",n),$(".empty-box").addClass("d-none"),l.empty(),console.log(n),n==="group"){M(e,n);return}U(e,n)}),$(".message-form").on("submit",function(e){if(e.preventDefault(),console.log(x.attr("content")),x.attr("content")==="group"){l.append(m(y.val(),"replies")),L(),y.val("");return}l.append(m(y.val(),"replies")),T(),y.val("")})});window.Echo.private("message."+i).listen("SendMessageEvent",function(e){console.log(e);const n=S.attr("content");console.log(e.to_id,n),e.from_user&&B(e.from_user),e.from_id==n&&(l.append(m(e.text,"sent")),b())});window.Echo.private("group."+i).listen("SendGroupMessageEvent",function(e){console.log(e);const n=S.attr("content");e.group_id==n&&(l.append(m(e.text,"sent")),b())}).listen(".GroupCreatedEvent",function(e){if(console.log("Group created event received:",e),console.log("Full event data:",JSON.stringify(e,null,2)),!e||!e.group){console.error("Group data not found in event:",e);return}const n=e.group;if($(`.contact[data-id='${n.id}'][data-type='group']`).length>0){console.log("Group already exists in list");return}const o=p+"/images/avatar.jpg",a=`
            <li class="contact" data-id="${n.id}" data-type="group">
                <div class="wrap">
                    <span class="contact-status offline"></span>
                    <img src="${o}" alt="avatar" />
                    <div class="meta">
                        <p class="name">${n.title}</p>
                    </div>
                </div>
            </li>`;$("#groups").append(a);const r=n.member_ids?n.member_ids.split(",").map(g=>String(g.trim())):[],f=String(n.owner_id);let h=!1;s&&s.length>0&&(h=s.some(g=>{const d=String(g.id),u=String(i);return(r.includes(d)||d===f)&&d!==u})),setTimeout(()=>{I(n.id),h&&(v(n.id,!0),c[n.id]=1)},100)});window.Echo.join("online").here(e=>{console.log(e),s=e,e.forEach(n=>{$(`.contact[data-id='${n.id}']`).find(".contact-status").removeClass("offline").addClass("online")})}).joining(e=>{console.log(e),s.find(n=>n.id===e.id)||s.push(e),$(`.contact[data-id='${e.id}']`).find(".contact-status").removeClass("offline").addClass("online")}).leaving(e=>{console.log(e),s=s.filter(n=>n.id!==e.id),$(`.contact[data-id='${e.id}']`).find(".contact-status").removeClass("online").addClass("offline")});function D(e){const n=String(e.id);if($(`#user_${n}`).length>0){console.log("User already exists in modal:",e.name);return}const o=$("#groupModal .border.rounded.p-3");if(o.length===0){console.warn("Modal member list container not found");return}const a=`
        <div class="form-check mb-2">
            <input class="form-check-input member-checkbox" type="checkbox" value="${e.id}" id="user_${e.id}">
            <label class="form-check-label" for="user_${e.id}">
                ${e.name}
            </label>
        </div>`;o.append(a),$(`#user_${e.id}`).on("change",function(){k()}),console.log("User added to modal:",e.name)}function k(){const e=document.querySelectorAll(".member-checkbox"),n=document.getElementById("member_ids");if(!n)return;const t=Array.from(e).filter(o=>o.checked).map(o=>o.value);n.value=t.join(",")}document.addEventListener("DOMContentLoaded",function(){const e=document.querySelectorAll(".member-checkbox"),n=document.getElementById("member_ids");e.forEach(o=>{o.addEventListener("change",k)});const t=document.getElementById("groupModal");t&&t.addEventListener("hidden.bs.modal",function(){e.forEach(o=>{o.checked=!1}),n&&(n.value="")})});function _(){const e=$('meta[name="base_url"]').attr("content");if(typeof jQuery>"u"||typeof $>"u"){console.error("jQuery is not loaded");return}const n=$("#groupForm").serialize();$.ajax({url:e+"/create-group",method:"POST",data:n,beforeSend:function(){},success:function(t){console.log(t);const o=document.getElementById("member_ids"),a=o?o.value:"",r=a?a.split(",").map(u=>String(u.trim())):[],f=String(t.owner_id);$("#groupModal").modal("hide"),$("#groupForm")[0].reset(),$("#member_ids").val(""),$(".member-checkbox").prop("checked",!1);const h=e+"/images/avatar.jpg",g=`
              <li class="contact" data-id="${t.id}" data-type="group">
                    <div class="wrap">
                        <span class="contact-status offline"></span>
                        <img src="${h}" alt="avatar" />
                        <div class="meta">
                            <p class="name">${t.title}</p>
                        </div>
                    </div>
                </li>`;$("#groups").append(g);let d=!1;s&&s.length>0&&(d=s.some(u=>{const E=String(u.id),j=String(i);return(r.includes(E)||E===f)&&E!==j})),setTimeout(()=>{I(t.id),d&&(v(t.id,!0),c[t.id]=1),setTimeout(()=>{const u=c[t.id]||0;(u>0||d)&&v(t.id,u>0||d)},500)},50),console.log(t)},error:function(t){console.error("Error creating group:",t)}})}(function(){function e(t){return t&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation()),_(),!1}function n(){const t=document.getElementById("saveGroupBtn");t&&t.addEventListener("click",e);const o=document.getElementById("groupForm");o&&o.addEventListener("submit",e,!0)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n(),document.addEventListener("submit",function(t){t.target&&t.target.id==="groupForm"&&e(t)},!0),document.addEventListener("click",function(t){t.target&&t.target.id==="saveGroupBtn"&&e(t)})})();typeof jQuery<"u"&&$(document).ready(function(){$("#saveGroupBtn").on("click",function(e){e.preventDefault(),_()}),$(document).on("submit","#groupForm",function(e){return e.preventDefault(),e.stopPropagation(),_(),!1})});
